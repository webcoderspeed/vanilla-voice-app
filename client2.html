<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CLIENT TWO</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body>
  CLIENT 2

  <script>
    (async () => {
      const socket = io('http://localhost:1337');
      const peerConnection = new RTCPeerConnection();

      peerConnection.ontrack = (event) => {
        const [remoteStream] = event.streams;
        const audioElement = document.createElement('audio');
        audioElement.srcObject = remoteStream;
        audioElement.autoplay = true;
        document.body.appendChild(audioElement);
      };

      socket.on('offer', async (offer) => {
        await peerConnection.setRemoteDescription(JSON.parse(offer));

        // Get the audio stream from the user's microphone
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

        // Display the local stream (optional)
        const audioElement = document.createElement('audio');
        audioElement.srcObject = stream;
        audioElement.autoplay = true;
        document.body.appendChild(audioElement);

        // Create an answer
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        // Send the answer to the other client via socket
        socket.emit('answer', JSON.stringify(peerConnection.localDescription));
      });

      socket.on('candidate', async (candidate) => {
        await peerConnection.addIceCandidate(JSON.parse(candidate));
      });

      peerConnection.onicecandidate = async (e) => {
        if (e.candidate) {
          console.log('ICE candidate:', e.candidate);
          await socket.emit('candidate', JSON.stringify(e.candidate));
        }
      };

    })();
  </script>
</body>

</html>